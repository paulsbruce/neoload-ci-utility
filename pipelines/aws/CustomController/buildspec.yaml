version: 0.2

env:
  variables:
    NLW_URL: $ENV_NLW_URL
  secrets-manager: # as an example from CodeBuild, private token in environment from Secrets Manager
    NLW_TOKEN: NLW_TOKEN
    NTS_URL: NTS_CREDENTIALS:NTS_URL
    NTS_LICENSE_ID: NTS_CREDENTIALS:NTS_LICENSE_ID
    NTS_USER: NTS_CREDENTIALS:NTS_USER
    NTS_PASS: NTS_CREDENTIALS:NTS_PASS

phases:
  install:
    commands:
      - whoami && pwd
      - printenv

  pre_build:
    commands:
      - whoami && pwd
      - ls -latr

  build:
    commands:
      - whoami && pwd
      - ls -latr /home/neoload

      - |
        /home/neoload/neoload/bin/NeoLoadCmd \
          -project example_test/default.yaml \
          -project example_test/slas/uat.yaml \
          -launch 'CodeBuild NeoLoadCmd' \
          -report $PWD/neoload-report/report.html,$PWD/neoload-report/report.xml \
          -SLAJUnitResults $PWD/neoload-report/junit-sla-results.xml \
          -noGUI \
          -nlweb \
          -nlwebToken $NLW_TOKEN \
          -NTS $NTS_URL \
          -NTSLogin $NTS_USER:$NTS_PASS \
          -leaseLicense $NTS_LICENSE_ID:51:1

  post_build:
    commands:
      # produce junit report on SLAs
      - pwd
      - ls -latr
      # if a prior step failed or err'd, don't bother waiting
      - bash -c "if [ /"$CODEBUILD_BUILD_SUCCEEDING/" == /"0/" ]; then exit 1; fi"

#reports:
  # report-name-or-arn:
  #   files:
  #     - $CODEBUILD_SRC_DIR/neoload_slas.junit.xml
  #   discard-paths: yes
  #   file-format: JunitXml
